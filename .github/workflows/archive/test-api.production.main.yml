name: Test API Main Deployment

on:
  workflow_call:
    inputs:
      api_deployment_url:
        required: true
        type: string

jobs:
  test-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¥ Install Backend Dependencies
        run: |
          cd backend
          npm ci
      
      - name: ğŸ§ª Run Backend Unit Tests
        run: |
          echo "ğŸ§ª Running backend unit tests..."
          cd backend
          npm test
        env:
          NODE_ENV: test
          JWT_SECRET: test-secret
      
      - name: ğŸ§ª Test API Health Check
        run: |
          echo "ğŸ¥ Testing main production API health at: ${{ inputs.api_deployment_url }}"
          
          # Test health endpoint with retry
          for i in {1..5}; do
            echo "ğŸ” Health check attempt $i/5..."
            if curl -f "${{ inputs.api_deployment_url }}/health" -m 15; then
              echo "âœ… API is healthy!"
              break
            fi
            
            if [ $i -eq 5 ]; then
              echo "âŒ API health check failed after 5 attempts"
              exit 1
            fi
            
            echo "â³ Waiting 10 seconds..."
            sleep 10
          done
      
      - name: ğŸ§ª Test API Endpoints
        run: |
          echo "ğŸš€ Testing main production API endpoints..."
          
          # Test auth endpoints
          echo "ğŸ“„ Testing auth endpoint..."
          if curl -f "${{ inputs.api_deployment_url }}/api/auth/health" -m 15; then
            echo "âœ… Auth endpoint is working!"
          else
            echo "âš ï¸ Auth endpoint not responding (may require authentication)"
          fi
          
          # Test assessment endpoints
          echo "ğŸ“„ Testing assessment endpoint..."
          if curl -f "${{ inputs.api_deployment_url }}/api/assessment/health" -m 15; then
            echo "âœ… Assessment endpoint is working!"
          else
            echo "âš ï¸ Assessment endpoint not responding (may require authentication)"
          fi
          
          echo "âœ… API endpoint tests completed!"
      
      - name: ğŸ¯ Run Backend Integration Tests
        run: |
          echo "ğŸ§ª Running backend integration tests..."
          cd backend
          npm run test:integration || true
        env:
          API_BASE_URL: ${{ inputs.api_deployment_url }}
          NODE_ENV: test
          JWT_SECRET: test-secret
        continue-on-error: true
      
      - name: ğŸ“Š API Test Summary
        run: |
          echo "ğŸ¯ Main Production API Testing Complete!"
          echo "ğŸ“ URL: ${{ inputs.api_deployment_url }}"
          echo "âœ… Unit tests passed"
          echo "âœ… Health checks passed"
          echo "âœ… Endpoint tests completed"
          echo "ğŸ“‹ Integration tests completed"