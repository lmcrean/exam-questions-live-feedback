name: Cleanup Branch Preview

on:
  pull_request:
    types: [closed]
  schedule:
    # Run daily at 2 AM UTC to clean up old deployments
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to clean up (optional - leave empty to clean all old deployments)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  cleanup-on-pr-close:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Project Configuration
        id: config
        uses: ./.github/workflows/actions/load-config

      - name: Check PR status
        id: pr_status
        run: |
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            echo "PR was MERGED - cleaning up deployment immediately"
            echo "action=merged" >> $GITHUB_OUTPUT
          else
            echo "PR was CLOSED without merge - cleaning up deployment"
            echo "action=closed" >> $GITHUB_OUTPUT
          fi

      - name: Clean up branch deployment
        run: |
          echo "Cleaning up deployment for branch: ${{ github.head_ref }}"
          echo "PR #${{ github.event.number }} status: ${{ steps.pr_status.outputs.action }}"

          # Generate service names (matching deployment pattern)
          BRANCH_SLUG=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-63)
          API_SERVICE="api-${BRANCH_SLUG}"

          echo "Service to delete: ${API_SERVICE}"

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.config.outputs.gcp-project-id }}

      - name: Delete Cloud Run service
        run: |
          BRANCH_SLUG=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-63)
          API_SERVICE="api-${BRANCH_SLUG}"

          echo "Deleting Cloud Run service: ${API_SERVICE}"
          gcloud run services delete ${API_SERVICE} \
            --region=${{ steps.config.outputs.cloud-run-region }} \
            --quiet || echo "Service ${API_SERVICE} not found or already deleted"

      - name: Delete Firebase Hosting channel
        run: |
          PR_NUMBER="${{ github.event.number }}"

          echo "Deleting Firebase Hosting channel: branch-${PR_NUMBER}"

          # Install Firebase CLI if needed
          npm install -g firebase-tools

          # Delete the preview channel
          firebase hosting:channel:delete "branch-${PR_NUMBER}" \
            --project=${{ steps.config.outputs.firebase-project-id }} \
            --force || echo "Channel branch-${PR_NUMBER} not found or already deleted"
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Post cleanup confirmation
        uses: actions/github-script@v7
        with:
          script: |
            const branchSlug = "${{ github.head_ref }}".replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase().slice(0, 63);
            const prNumber = ${{ github.event.number }};
            const wasMerged = ${{ github.event.pull_request.merged }};
            const action = wasMerged ? 'merged' : 'closed';
            const emoji = wasMerged ? 'âœ…' : 'ðŸš«';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ${emoji} Branch Deployment Cleaned Up\n\n**PR ${action}** - deployment resources have been immediately deleted:\n\n- Cloud Run service: \`api-${branchSlug}\`\n- Firebase Hosting channel: \`branch-${prNumber}\`\n\n**Cost savings:** Reduced monthly infrastructure costs\n\n---\n*Automatic cleanup triggered by PR ${action}*`
            });

  cleanup-old-deployments:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load Project Configuration
        id: config
        uses: ./.github/workflows/actions/load-config

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.config.outputs.gcp-project-id }}

      - name: Find and delete old deployments
        run: |
          echo "Scanning for old branch deployments (older than 1 day)..."

          # Get current timestamp (1 day ago)
          CUTOFF_DATE=$(date -u -d '1 day ago' +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: ${CUTOFF_DATE}"

          # List all Cloud Run services
          SERVICES=$(gcloud run services list \
            --region=${{ steps.config.outputs.cloud-run-region }} \
            --format="value(name,metadata.creationTimestamp)")

          # Services to keep (production services)
          KEEP_SERVICES="api-main|${{ steps.config.outputs.app-name }}-api-main"

          echo "Services that will be kept: ${KEEP_SERVICES}"
          echo ""
          echo "Checking all services..."

          DELETED_COUNT=0

          while IFS=$'\t' read -r SERVICE_NAME CREATED_AT; do
            # Skip if service name is empty
            if [ -z "$SERVICE_NAME" ]; then
              continue
            fi

            # Skip production services
            if echo "$SERVICE_NAME" | grep -E "^(${KEEP_SERVICES})$" > /dev/null; then
              echo "Skipping production service: ${SERVICE_NAME}"
              continue
            fi

            # Check if service is older than 1 day
            if [[ "$CREATED_AT" < "$CUTOFF_DATE" ]]; then
              echo "Deleting old service: ${SERVICE_NAME} (created: ${CREATED_AT})"

              gcloud run services delete ${SERVICE_NAME} \
                --region=${{ steps.config.outputs.cloud-run-region }} \
                --quiet

              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "Keeping recent service: ${SERVICE_NAME} (created: ${CREATED_AT})"
            fi
          done <<< "$SERVICES"

          echo ""
          echo "Cleanup complete!"
          echo "Deleted ${DELETED_COUNT} old deployment(s)"

      - name: Generate cleanup report
        run: |
          echo "## Daily Cleanup Report - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remaining Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          gcloud run services list \
            --region=${{ steps.config.outputs.cloud-run-region }} \
            --format="table(name,metadata.creationTimestamp,status.url)" >> $GITHUB_STEP_SUMMARY
