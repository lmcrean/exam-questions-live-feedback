name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      api_url:
        description: 'API deployment URL'
        required: true
        type: string
      web_url:
        description: 'Web deployment URL'
        required: true
        type: string
      deployment_type:
        description: 'Type of deployment (main or branch)'
        required: true
        type: string
      branch_name:
        description: 'Branch name for branch deployments'
        required: false
        type: string
      pr_number:
        description: 'PR number for branch deployments'
        required: false
        type: string

jobs:
  test-api:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name || github.ref }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ğŸ“¥ Install Dependencies (Monorepo)
        run: |
          npm ci

      - name: ğŸ”§ Build Shared Packages
        run: |
          cd packages/db
          npm run build

      - name: ğŸ§ª Run Backend Unit Tests
        run: |
          echo "ğŸ§ª Running backend unit tests..."
          cd apps/api
          npm test
        env:
          NODE_ENV: test
          JWT_SECRET: test-secret

      - name: ğŸ¥ Test API Health Check
        run: |
          echo "ğŸ¥ Testing API health at: ${{ inputs.api_url }}"

          # Test health endpoint with retry
          for i in {1..5}; do
            echo "ğŸ” Health check attempt $i/5..."
            if curl -f "${{ inputs.api_url }}/api/health" -m 15; then
              echo "âœ… API is healthy!"
              break
            fi

            if [ $i -eq 5 ]; then
              echo "âŒ API health check failed after 5 attempts"
              exit 1
            fi

            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
          done

      - name: ğŸ§ª Test API Endpoints
        run: |
          echo "ğŸš€ Testing API endpoints..."

          # Test auth endpoints
          echo "ğŸ“„ Testing auth endpoint..."
          if curl -f "${{ inputs.api_url }}/api/auth/health" -m 15; then
            echo "âœ… Auth endpoint is working!"
          else
            echo "âš ï¸ Auth endpoint not responding (may require authentication)"
          fi

          # Test assessment endpoints
          echo "ğŸ“„ Testing assessment endpoint..."
          if curl -f "${{ inputs.api_url }}/api/assessment/health" -m 15; then
            echo "âœ… Assessment endpoint is working!"
          else
            echo "âš ï¸ Assessment endpoint not responding (may require authentication)"
          fi

          echo "âœ… API endpoint tests completed!"

      - name: ğŸ¯ Run Backend Integration Tests
        run: |
          echo "ğŸ§ª Running backend integration tests..."
          cd apps/api
          npm run test:integration || echo "âš ï¸ No integration tests found or tests failed"
        env:
          API_BASE_URL: ${{ inputs.api_url }}
          NODE_ENV: test
          JWT_SECRET: test-secret
          BRANCH_NAME: ${{ inputs.branch_name }}
          GITHUB_HEAD_REF: ${{ inputs.branch_name }}
        continue-on-error: true

      - name: ğŸ“‹ Upload API Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results-${{ inputs.deployment_type }}-${{ inputs.pr_number || 'main' }}
          path: |
            apps/api/test-results/
            apps/api/coverage/
          retention-days: 7
          if-no-files-found: ignore

  test-integration:
    needs: test-api
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name || github.ref }}

      - name: ğŸ” Environment Validation
        run: |
          echo "ğŸ§ª Web App: ${{ inputs.web_url }}"
          echo "ğŸ§ª API Service: ${{ inputs.api_url }}"

          if [[ ! "${{ inputs.web_url }}" =~ ^https?:// ]] || [[ ! "${{ inputs.api_url }}" =~ ^https?:// ]]; then
            echo "âŒ Invalid URL format"
            exit 1
          fi

      - name: ğŸ¥ API Health Check
        run: |
          echo "ğŸ” Testing API health endpoint..."

          for i in {1..3}; do
            echo "Health check attempt $i/3..."

            if curl -f "${{ inputs.api_url }}/api/health" -m 15; then
              echo "âœ… API health check passed"
              break
            fi

            if [ $i -eq 3 ]; then
              echo "âŒ API health check failed after 3 attempts"
              exit 1
            fi

            echo "â³ Waiting 10 seconds..."
            sleep 10
          done

      - name: ğŸ“¡ API Endpoint Tests
        run: |
          echo "ğŸ” Testing key API endpoints..."
          API_URL="${{ inputs.api_url }}"

          # Test GitHub API endpoints (if available)
          echo "Testing GitHub API endpoints..."

          # Test basic API routes
          curl -f "$API_URL/api/github/health" -m 10 || {
            echo "âš ï¸ GitHub API health endpoint not available"
          }

          # Test if API responds with proper JSON
          echo "Testing API JSON response..."
          RESPONSE=$(curl -s "$API_URL/api/health" -m 10)
          if [[ "$RESPONSE" == *"{"* ]]; then
            echo "âœ… API returns JSON responses"
          else
            echo "âš ï¸ API response format may be incorrect"
          fi

          # Test auth signup endpoint (uses bcrypt - catches segmentation faults)
          echo "ğŸ” Testing auth signup endpoint (CRITICAL - tests bcrypt functionality)..."
          TIMESTAMP=$(date +%s)
          TEST_USER="test_ci_${TIMESTAMP}@example.com"

          SIGNUP_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL/api/auth/signup" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"${TEST_USER}\",\"password\":\"TestPass123!\",\"username\":\"testuser_${TIMESTAMP}\"}" \
            -m 15)

          SIGNUP_HTTP_CODE=$(echo "$SIGNUP_RESPONSE" | tail -n1)
          SIGNUP_BODY=$(echo "$SIGNUP_RESPONSE" | head -n-1)

          echo "Signup response code: $SIGNUP_HTTP_CODE"
          echo "Signup response body: $SIGNUP_BODY"

          if [[ "$SIGNUP_HTTP_CODE" == "201" ]] || [[ "$SIGNUP_HTTP_CODE" == "200" ]]; then
            echo "âœ… Auth signup endpoint working (bcrypt is functional)"
          elif [[ "$SIGNUP_HTTP_CODE" == "503" ]]; then
            echo "âŒ CRITICAL: Signup endpoint returned 503 - likely segmentation fault in bcrypt"
            exit 1
          elif [[ "$SIGNUP_HTTP_CODE" == "409" ]]; then
            echo "âš ï¸ User already exists (this is OK for testing)"
          else
            echo "âš ï¸ Unexpected response code: $SIGNUP_HTTP_CODE"
            echo "Response: $SIGNUP_BODY"
          fi

          echo "âœ… API endpoint tests completed"

      - name: ğŸ”— CORS Configuration Test
        run: |
          echo "ğŸ” Testing CORS configuration..."

          # Test if CORS is properly configured
          curl -H "Origin: ${{ inputs.web_url }}" \
               -H "Access-Control-Request-Method: GET" \
               -H "Access-Control-Request-Headers: Content-Type" \
               -X OPTIONS \
               "${{ inputs.api_url }}/api/health" -m 10 || {
            echo "âš ï¸ CORS preflight test failed"
          }

          echo "âœ… CORS configuration test completed"

      - name: ğŸ“± Web App Accessibility Test
        run: |
          echo "ğŸ” Testing web app accessibility..."

          # Test if web app serves the main page
          if curl -f "${{ inputs.web_url }}" -m 15 >/dev/null 2>&1; then
            echo "âœ… Web app is serving content"
          else
            echo "âŒ Web app accessibility test failed"
            exit 1
          fi

      - name: ğŸ”Œ Integration Connectivity Test
        run: |
          echo "ğŸ” Testing web app to API connectivity..."

          WEB_URL="${{ inputs.web_url }}"
          API_URL="${{ inputs.api_url }}"

          # Extract domain from web URL to test cross-origin setup
          WEB_DOMAIN=$(echo "$WEB_URL" | sed 's|https\?://||' | sed 's|/.*||')
          API_DOMAIN=$(echo "$API_URL" | sed 's|https\?://||' | sed 's|/.*||')

          echo "ğŸŒ Web domain: $WEB_DOMAIN"
          echo "ğŸŒ API domain: $API_DOMAIN"

          if [[ "$WEB_DOMAIN" != "$API_DOMAIN" ]]; then
            echo "âœ… Cross-origin setup detected (web and API on different domains)"
          else
            echo "âœ… Same-origin setup detected"
          fi

          echo "âœ… Integration connectivity test completed"

      - name: ğŸ§ª Performance Test
        run: |
          echo "ğŸ” Running basic performance tests..."

          # Test response times
          echo "Testing API response time..."
          API_TIME=$(curl -w "%{time_total}" -o /dev/null -s "${{ inputs.api_url }}/api/health")
          echo "API response time: ${API_TIME}s"

          echo "Testing web app response time..."
          WEB_TIME=$(curl -w "%{time_total}" -o /dev/null -s "${{ inputs.web_url }}")
          echo "Web app response time: ${WEB_TIME}s"

          echo "âœ… Performance tests completed"

      - name: ğŸ”„ Integration Test Summary
        run: |
          echo "ğŸ§ª Integration Results: âœ… PASSED"
          echo "ğŸŒ Web App: ${{ inputs.web_url }}"
          echo "âš¡ API Service: ${{ inputs.api_url }}"
          echo "âœ… Both services are healthy and properly configured"

  test-e2e:
    needs: [test-api, test-integration]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name || github.ref }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: ğŸ“¥ Install E2E Dependencies
        run: |
          echo "ğŸ“¦ Installing frontend dependencies for E2E tests..."
          cd apps/web
          npm ci

      - name: ğŸ­ Install Playwright Browsers
        run: |
          cd apps/web
          npx playwright install chromium firefox webkit
          npx playwright install-deps

      - name: ğŸ” Environment Setup
        run: |
          echo "ğŸŒ Web URL: ${{ inputs.web_url }}"
          echo "ğŸ”— API URL: ${{ inputs.api_url }}"
          echo "ğŸ”„ Deployment Type: ${{ inputs.deployment_type }}"

          if [ "${{ inputs.deployment_type }}" = "branch" ]; then
            echo "ğŸŒ¿ Branch: ${{ inputs.branch_name }}"
            echo "ğŸ”¢ PR Number: ${{ inputs.pr_number }}"
          fi

          # Validate URLs
          if [[ ! "${{ inputs.web_url }}" =~ ^https?:// ]] || [[ ! "${{ inputs.api_url }}" =~ ^https?:// ]]; then
            echo "âŒ Invalid URL format"
            exit 1
          fi

      - name: â³ Wait for Deployments to Stabilize
        run: |
          echo "â³ Allowing 30 seconds for deployments to fully stabilize..."
          sleep 30

          echo "ğŸ¥ Final health checks before e2e tests..."

          # Check API health
          for i in {1..3}; do
            echo "API health check $i/3..."
            if curl -f "${{ inputs.api_url }}/api/health" -m 10 >/dev/null 2>&1; then
              echo "âœ… API is healthy"
              break
            fi

            if [ $i -eq 3 ]; then
              echo "âŒ API failed final health check"
              exit 1
            fi

            sleep 5
          done

          # Check web app accessibility
          for i in {1..3}; do
            echo "Web accessibility check $i/3..."
            if curl -f "${{ inputs.web_url }}" -m 10 >/dev/null 2>&1; then
              echo "âœ… Web app is accessible"
              break
            fi

            if [ $i -eq 3 ]; then
              echo "âŒ Web app failed final accessibility check"
              exit 1
            fi

            sleep 5
          done

      - name: ğŸ§ª Run E2E Tests
        run: |
          cd apps/web

          # Run e2e tests against deployed services
          echo "ğŸ­ Running e2e tests against deployed services..."
          echo "ğŸŒ Testing Web: ${{ inputs.web_url }}"
          echo "ğŸ”— Testing API: ${{ inputs.api_url }}"

          # Run Playwright tests in headless mode with timeout
          # FAIL FAST: If tests fail, the build should fail
          npx playwright test --timeout=60000

          echo "âœ… E2E tests passed!"
        env:
          # Set environment variables for the Playwright config
          CI: true
          WEB_DEPLOYMENT_URL: ${{ inputs.web_url }}
          API_DEPLOYMENT_URL: ${{ inputs.api_url }}
          FIREBASE_HOSTING_URL: ${{ inputs.web_url }}
          CLOUD_RUN_URL: ${{ inputs.api_url }}
          VITE_API_URL: ${{ inputs.api_url }}
          BRANCH_NAME: ${{ inputs.branch_name }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GITHUB_HEAD_REF: ${{ inputs.branch_name }}
          GITHUB_EVENT_NUMBER: ${{ inputs.pr_number }}

      - name: ğŸ“Š Upload E2E Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ inputs.deployment_type }}-${{ inputs.pr_number || 'main' }}
          path: apps/web/playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: ğŸ“¸ Upload E2E Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots-${{ inputs.deployment_type }}-${{ inputs.pr_number || 'main' }}
          path: apps/web/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ“‹ E2E Test Summary
        if: always()
        run: |
          echo "ğŸ­ E2E Test Summary"
          echo "ğŸŒ Web App: ${{ inputs.web_url }}"
          echo "ğŸ”— API Service: ${{ inputs.api_url }}"
          echo "ğŸ”„ Deployment Type: ${{ inputs.deployment_type }}"

          if [ "${{ inputs.deployment_type }}" = "branch" ]; then
            echo "ğŸŒ¿ Branch: ${{ inputs.branch_name }}"
            echo "ğŸ”¢ PR: #${{ inputs.pr_number }}"
          fi

          if [ $? -eq 0 ]; then
            echo "âœ… E2E tests completed successfully!"
          else
            echo "âŒ E2E tests failed - check artifacts for details"
          fi

  update-pr-status:
    needs: [test-api, test-integration, test-e2e]
    if: inputs.deployment_type == 'branch' && always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ’¬ Update PR with Test Status
        uses: actions/github-script@v7
        with:
          script: |
            const apiTestStatus = '${{ needs.test-api.result }}';
            const integrationStatus = '${{ needs.test-integration.result }}';
            const e2eStatus = '${{ needs.test-e2e.result }}';

            const allTestsPassed = apiTestStatus === 'success' && integrationStatus === 'success' && e2eStatus === 'success';
            const statusEmoji = allTestsPassed ? 'âœ…' : 'âŒ';
            const statusText = allTestsPassed ? 'All tests passed!' : 'Some tests failed';

            const commentBody = `### ğŸ§ª Test Results

            - **API Tests**: ${apiTestStatus === 'success' ? 'âœ… Passed' : apiTestStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            - **Integration Tests**: ${integrationStatus === 'success' ? 'âœ… Passed' : integrationStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            - **E2E Tests**: ${e2eStatus === 'success' ? 'âœ… Passed' : e2eStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}

            ${statusEmoji} ${statusText}

            ---
            *ğŸ”„ Last updated: ${new Date().toLocaleString()} UTC*

            <!-- BRANCH_TEST_STATUS_COMMENT -->`;

            const comments = await github.rest.issues.listComments({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('<!-- BRANCH_DEPLOYMENT_COMMENT -->')
            );

            if (existingComment) {
              // Append test status to existing deployment comment
              const updatedBody = existingComment.body.replace(
                '<!-- BRANCH_DEPLOYMENT_COMMENT -->',
                `${commentBody}\n\n<!-- BRANCH_DEPLOYMENT_COMMENT -->`
              );

              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: updatedBody
              });
            } else {
              // Create new comment if deployment comment doesn't exist
              await github.rest.issues.createComment({
                issue_number: ${{ inputs.pr_number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }
